# 선착순 티켓 예매 사이트 by TDD

프로젝트 목적 : 티켓 선착순 예매를 위해 대용량 트래픽이 순간적으로 몰렸을 때, 적절한 처리 방안을 모색하고
구현하며 트러블 슈팅을 하는 소규모 사이드 프로젝트
추가: 관리자 기능은 따로 만들지 않을 것이기에, 공연(한화이글스 vs LG트윈스 한국시리즈), 좌석, 최대 구매 가능 티켓 수 등은 임의로 생성
------------------------------------------------------------------------
## 비즈니스 요구사항 정리 (비개발자랑 소통해야 함. 전문 용어 사용x)

### auth
1. 회원가입을 할 수 있어야 한다.
    1. 비밀번호는 해시로 저장되어야 한다. (암호화 종류, 장단점 조사분석)
    2. 아이디는 이메일로 진행하고, 중복 가입은 허용되지 않는다. (검증 방식은 여러개? 검증 코드는 어디에 두나? 클래스 위치)
2. 로그인을 할 수 있어야 한다.
    1. 로그인 시간은 30분 이고 만료되면 재 로그인 해야 한다.

### reservation
1. 로그인한 회원은 회차당 최대 n개 티켓을 예매 가능하다. (한 번에 n개? 총 n개?) => 총 n개
    1. 로그인하지 않은 회원은 예매할 수 없다.
2. 좌석 선택 후 예매하기를 클릭할 시 좌석은 예매된다.
3. 클라이언트 측에서 예매 가능한 회차만 화면에 보여준다고 가정. but 혹시 모르니 서버에서도 검증 필요
    1. 예매하려는 공연-회차가 정상적인 시간인지(과거x, 진행중x), 정상적인 상황인지(예매 오픈 상태)
    2. 등등
4. 일정 요청 수가 넘어가면 대기큐를 생성하여 진입하여야 한다.
5. 회차의 재고가 1 이상이면 좌석 선택 창으로 이동할 수 있다.(회차 당 좌석 상세 정보 조회 가능)
    1. 회차의 재고가 0 이하면 좌석 선택 창으로 넘어갈 수 없다(회차 당 좌석 상세 정보 조회 불가능)
6. 같은 회차의 같은 좌석을 예매하려고 하면 실패한다.
7. 한 명의 회원은 공연별, 회차별, 좌석별로 다양한 예매를 할 수 있다.
    1. (공연 1의 회차 1의 좌석 1, 2), (공연 1의 회차 1의 좌석 3, 4), (공연 1의 회차 2의 좌석 1, 2), (공연 2의 회차 1의 좌석 1)

### hold
1. 한 좌석은 같은 시점에 오직 한 사용자에게만 선점 가능하다.
2. 여러 좌석을 한 번에 선점 시도할 때는 전부 성공 or 전부 실패여야 한다.
3. 선점을 하면 만료시간(선점한 시간으로부터 5분) 안에 결제까지 진행해야 한다.
    1. 진행하지 않을 시 선점이 취소된다.
4. 회원당 한 회차에 최대 4개의 좌석만 선점 가능하다.
    1. 한 번의 선점 요청 당 최대 4개까지 가능하다.
5. 사용자가 선점을 명시적으로 취소할 수 있어야 한다.
6. 동일 사용자가 동일 좌석을 중복 선점 시도하면 기존 선점 정보를 반환한다(멱등성).



-----------------------------------------------------------------------------------
## 기술 정리

### auth
1. 인메모리 세션으로 우선 구현한 뒤, redis session, jwt로 수정 보완할 계획
2. customArgumentResolver를 구현하여 controller에서 session을 통해 로그인한 member 가져오기
3. 이후 권한이 들어가면 인가 처리를 interceptor를 구현할 예정
4. 필터는 언제?

### hold
1. SEAT_HOLD 테이블에 선점 내역 저장 후, 스케쥴링을 통해 만료된 선점 원복 처리.
2. Redis 이용한 선점 저장, 만료 처리



-------------------------------------------------------------------------------------------

## TDD

- [ ] member
    - [x] 정상 입력값이면 Member가 생성된다
    - [x] 비밀번호는 해시로 암호화되어 저장된다.
    - [x] 회원 단일 조회를 성공한다.
    - [x] 존재하지 않는 id는 회원조회를 실패한다.
    - [x] 정상적인 값이라면 로그인을 성공한다.
    - [x] 비밀번호가 일치하지 않으면 로그인이 실패한다.
    - [x] 존재하지 않는 이메일로 로그인하면_실패한다.
- [ ] email
    - [x] 올바르지 않은 이메일이면 Email 생성을 실패한다
    - [x] 올바른 이메일이면 Email 생성을 성공한다
    - [x] 중복 이메일은 허용하지 않는다.
- [ ] password
    - [ ] 비밀번호가 정책에 맞지 않으면 회원가입에 실패한다.

- [ ] reservation
    - [x] 재고가 있다면 예매를 성공한다.
    - [x] 재고가 없다면 예매를 실패한다.
    - [x] 과거 회차는 예매가 불가능하다.
    - [x] 예매 오픈 시간 전에는 예매가 불가능하다.

- [ ] performance
    - [x] 회차 시작 시간이 종료 시간보다 느리면 예외가 발생한다.
    - [x] 회차의 재고가 0 이하라면 예매 가능한 전체 좌석 조회는 실패한다.
    - [x] 회차의 재고가 1 이상이라면 예매 가능한 전체 좌석 조회가 성공한다.

- [ ] seat-hold
    - [ ] 같은 좌석을 동시에 선점하려 하면 한 명만 성공한다.
    - [ ] 여러 좌석을 한 번에 선점 시도할 때는 전부 성공하거나 전부 실패한다.
    - [ ] 선점을 하면 선점 상태가 PENDING으로 변경된다.
    - [ ] 선점 후 5분 이내에 결제를 완료하면 선점 상태를 CONFIRMED로 변경한다.
    - [ ] 스케줄러가 만료된 선점을 정리하여 좌석을 AVAILABLE로 복원한다.
    - [ ] 스케쥴러는 만료된 좌석 선점 상태를 RESTORED로 복원한다.
    - 
--------------------------------------------------------------------

## 테이블 연관관계 정리
1. Performances(회차) <-> PerformanceSeat(회차별 좌석) (1 : N)
2. seat(좌석) <-> PerformanceSeat(회차별 좌석) (1 : N)
3. Performance(회차) <-> Reservation(예매 정보) (1 : N)
4. Reservation(예매 정보) <-> ReservationSeat(예매별 좌석) (1 : N)
5. ReservationSeat(예매별 좌석) <-> PerformanceSeat(회차별 좌석) (1 : 1)
6. SeatHold(좌석 선점) <-> Member(회원) (N : 1)
7. SeatHold(좌석 선점) <-> PerformanceSeat(회차별 좌석) (N : 1)
